<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="users">
    </div>
    <input data-testid="nickname-box" id="input-nick">
    <button data-testid="nickname-button" id="change-nick">Enviar</button>
    <ul id="messages"></ul>
    <input data-testid="message-box" id="input">
    <button data-testid="send-button" id="send">Enviar</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
    <script>
        function createMessage(message) {
            const li = document.createElement('li');
            li.innerText = message;
            li.setAttribute('data-testid', 'message');
            return li;
        }
        function createUser(nick, id) {
            const div = document.createElement('div');
            div.innerText = nick;
            div.setAttribute('data-testid', 'online-user');
            div.setAttribute('id', id);
            return div;
        }
        socket = io();
        socket.on('messages', ({ messages, online }) => {
            const messagesElements = messages.map((message) => createMessage(message));
            document.getElementById('messages').append(...messagesElements);
            const randomName = Math.random().toString().replace('.', '').slice(0, 16).padStart(16, 'x');
            const userEl = createUser(randomName, 'user-name');
            socket.emit('change-nick', randomName);
            const users = Object.keys(online).map((userId) => createUser(online[userId], userId));
            const usersContainer = document.getElementById('users');
            usersContainer.append(userEl);
            usersContainer.append(...users);
        });
        document.getElementById('send').addEventListener('click', () => {
            const chatMessage = document.getElementById('input').value;
            const nickname = document.getElementById('user-name').innerText;
            socket.emit('message', {
                chatMessage,
                nickname,
            });
        });
        document.getElementById('change-nick').addEventListener('click', () => {
            const newNickname = document.getElementById('input-nick').value;
            document.getElementById('user-name').innerText = newNickname;
            socket.emit('change-nick', newNickname);
        });
        socket.on('message', (message) => {
            const li = createMessage(message);
            document.getElementById('messages').append(li);
        });
        window.onbeforeunload = function(event) {
            socket.disconnect();
        };
        socket.on('user-disconnect', (id) => {
            document.querySelectorAll('#users div').forEach((userEl) => {
                if (userEl.id === id) {
                    userEl.remove();
                }
            });
        });
        socket.on('change-nick', ({nick, id}) => {
            let foundUser = false;
            document.querySelectorAll('#users div').forEach((userEl) => {
                if (userEl.id === id) {
                    foundUser = true;
                    userEl.innerText = nick;
                }
            });
            if (!foundUser) {
                const user = createUser(nick, id);
                document.getElementById('users').append(user);
            }
        });
    </script>
</body>
</html>
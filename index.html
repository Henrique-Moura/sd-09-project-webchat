<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Chat Trybe</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    html,
    body {
      height: 100%;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    #chat {
      align-items: center;
      display: flex;
      flex-direction: column;
      height: 100%;
      justify-content: center;
    }

    input {
      border: 1px solid #ddd;
      font-size: 14px;
      height: 50px;
      padding: 0 20px;
      width: 600px;
    }

    button {
      background: #069;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      height: 50px;
      line-height: 50px;
      margin-top: 10px;
      text-align: center;
      width: 600px;
    }

    .messages {
      border: 1px solid #ddd;
      height: 400px;
      list-style: none;
      margin: 20px 0;
      padding: 20px;
      width: 600px;
    }
  </style>
</head>

<body>
  <form id="chat">
    <input type="text" name="username" id="nickname-box" placeholder="Digite seu nickname" data-testid="nickname-box">
    <button id="nickname-button" data-testid="nickname-button">
      Send
    </button>
    <ul id="userList"></ul>
    <div type="text" class="messages"></div>
    <input type="text" name="message" id="message" placeholder="Digite sua mensagem" data-testid="message-box">
    <button type="submit" id="send-button" data-testid="send-button">Enviar</button>
  </form>
  <script type="text/javascript">

    const socket = io();

    let nickname;
    socket.on('connect', () => {
      nickname = socket.id.substring(0, 16)
      socket.emit('sendUser', nickname);
    })

    socket.on('login', (usersOnline) => {
      const userUl = document.querySelector('#userList');
      userUl.innerText = ''

      const li = document.createElement('li');
      li.setAttribute("data-testid", "online-user");
      li.innerText = nickname;
      userUl.appendChild(li);

      usersOnline.forEach((user) => {
        const li = document.createElement('li');
        if (nickname === user.nickname) return;
        li.setAttribute("data-testid", "online-user");
        li.innerText = user.nickname;
        userUl.appendChild(li);
      });
    })

    const messageBtn = document.querySelector('#send-button');
    messageBtn.addEventListener('click', (event) => {
      event.preventDefault();

      const inputNickname = document.querySelector('#nickname-box');
      const inputMessage = document.querySelector('#message');

      const messageObj = {
        nickname,
        chatMessage: inputMessage.value,
      }

      socket.emit('message', messageObj)
    })

    const nicknameBtn = document.querySelector('#nickname-button');
    nicknameBtn.addEventListener('click', (event) => {
      event.preventDefault();

      const inputNickname = document.querySelector('#nickname-box')
      nickname = inputNickname.value

      socket.emit('updateNickname', nickname);
    })

    socket.on('message', (message) => createMessage(message));
    const createMessage = (message) => {
      const messagesUl = document.querySelector('.messages');
      const li = document.createElement('li');

      li.setAttribute("data-testid", "message");
      li.innerText = message;
      messagesUl.appendChild(li);
    };

    socket.on('findMessages', (allMessages) => {
      const messagesUl = document.querySelector('.messages');

      allMessages.forEach(({ chatMessage, nickname: user, timestamp }) => {
        const li = document.createElement('li');

        li.setAttribute("data-testid", 'message');
        li.innerText = `${timestamp} - ${user}: ${chatMessage}`;
        messagesUl.appendChild(li);
      });
    });
  </script>
</body>

</html>
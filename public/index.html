<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }

        section {
          height: 80vh;
          justify-items: center;
          width: 49%;
          margin-bottom: 10px;
        }

        ul {
          list-style-type: none;
          overflow: hidden;
        }

        .allChatContainer {
          display: flex;
          flex-wrap: wrap;
          justify-content: space-between;
          margin: auto;
          width: 85%;
        }

        .btn {
          width: 20%;
        }

        .inputText {
          width: 80%;
        }

        .inputMessageContainer {
          align-items: center;
          background-color: rgb(197, 132, 132);
          display: flex;
          justify-content: center;
          width: 100%;
        }

        .messageList{
          height: 100%;
        }

        .messagesContainer {
          background-color: rgba(110, 155, 66, 0.3);
          border: 1px solid rgba(110, 155, 66, 0.6);
          padding: 20px;
        }

        .nickContainer {
          border-bottom: 1px solid rgba(110, 155, 66, 0.6);
          display: flex;
          flex-wrap: wrap;
          padding: 20px;
          width: 100%;
        }

        .usersControl {
          background-color: rgba(110, 155, 66, 0.3);
          border: 1px solid rgba(110, 155, 66, 0.6);
        }

        .title {
          align-items: center;
          display: flex;
          justify-content: center;
          height: 10vh;
          width: 100%;
        }

        .title2 {
          padding: 0 0 10px 0;
          width: 100%;
        }

        .title3 {
          margin: 20px 0 0 20px;
          width: 100%;
        }

        .usersContainer {
          
          padding: 20px;
        }

        @media only screen and (max-width: 660px) {
          section {
            height: auto;
            width: 100%;
          }
          
          .allChatContainer {
            flex-flow: column wrap;
            align-items: center;
          }

          .messageList {
            height: 55vh;
          }
        }
    </style>
    <title>Trybe Chat</title>
  </head>
  <body>
    <div class="allChatContainer">
      <h1 class="title">Trybe CHAT></h1>
      <section class="usersControl">
        <h3 class="title3">Entrar no chat</h3>
        <div class="nickContainer">
          <input type="text" class="inputText" id="inputNick" data-testid="nickname-box">
          <button class="btn" id="btnChange" data-testid="nickname-button" onclick={userUpdateNick()}>Enviar</button>
        </div>
        <div class="usersContainer">
          <h3 class="title2">Usuários Online</h3>
          <ul class="usersList">
          </ul>
        </div>
      </section>
      <section class="messagesContainer">
        <ul class="messageList">
          <h3 class="title2">Mensagens do chat</h3>
          <li>oi</li>
          <li>Kolée</li>
          <li>td na boa?</li>
        </ul>
      </section>
      <div class="inputMessageContainer">
        <input type="text" class="inputText" id="inputMessage" data-testid="message-box">
        <button class="btn" id="btnSend" data-testid="send-button" onclick={sendMessage()}>Enviar</button>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = window.io();
    </script>
    <script>
      //elements to be changed 
      const btnChange = document.querySelector('#btnChange');
      const btnSend = document.querySelector('#btnSend');
      const listUsers = document.querySelector('.usersList');
      const listMessages = document.querySelector('.messageList');
      const inputMessage = document.querySelector('#inputMessage');
      const inputNick = document.querySelector('#inputNick');

      //service functions
      let sessionID;
      let nickname;
      const addUserToTop = (liElement) => listUsers.insertBefore(liElement, listUsers.firstChild);
      const addUserToBottom = (liElement) => listUsers.appendChild(liElement);
      const addMessageToBottom = (liElement) => listMessages.appendChild(liElement);
      const createUserLiElement = (id, content, testid) => {
        const li = document.createElement('li');
        li.id = id;
        li.innerText = content;
        li.setAttribute('data-testid', testid);
        return li;
      };
      const addMessageToList = (msgObj) => {
        const { message, nickname, timestamp } = msgObj;
        const dateConverted = new Date(timestamp);
        const date = `${dateConverted.getDate()}-${dateConverted.getMonth() + 1}-${dateConverted.getFullYear()}`;
        const hours = `${dateConverted.getHours()}:${dateConverted.getMinutes()}:${dateConverted.getSeconds()}`;
        const datetime = `${date} ${hours}`;
        const stringMessage = `${datetime} - ${nickname}: ${message}`;
        const messageObj = createUserLiElement('', stringMessage, 'message');
        listMessages.appendChild(messageObj);
      };
      const addGlobalMessageToList = (message) => {
        const messageObj = createUserLiElement('', message, 'global-message');
        listMessages.appendChild(messageObj);
      };

      // SERVER ACTIONS -----------------------------------------------------------------
      // generate random user and add him to the top
      socket.on('generateUser', ({id, name, arrayOfUsers}) => {
        sessionID = id;
        nickname = name;
        arrayOfUsers.forEach(({_id, name}) => {
          const userObj = createUserLiElement(_id, name, 'online-user');
          addUserToTop(userObj);
        });
        socket.emit('sendUserToOthers', {id, name});
      });

      // send the random user created previously, to the other users.
      socket.on('userToBotton', ({id, name}) => {
        const userObj = createUserLiElement(id, name, 'online-user');
        addUserToBottom(userObj);
      });

      // remove the user when he leaves the chat.
      socket.on('userDisconnected', (id) => {
        const userElement = document.getElementById(id);
        if (userElement) userElement.remove();
      });

      // change the name of the user.
      socket.on('resolveUserChangeNick', ({ id, name }) => {
        const userElement = document.getElementById(id);
        userElement.innerText = name;
      });

      socket.on('resolveMessageSend', (messageMongoObj) => {
        addMessageToList(messageMongoObj);
      });

      socket.on('resolveMessagesList', (messagesArray) => {
        messagesArray.forEach((messageMongoObj) => {
          addMessageToList(messageMongoObj);
        });
      });

      // CLIENT ACTIONS -----------------------------------------------------------------
      // insert user at the beggining of list -  when app starts
      function userJoin() {
        socket.emit('userConnected');
      }

      // update userName when click on btnNick
      function userUpdateNick() {
        nickname = inputNick.value;
        socket.emit('requestUserChangeNick', { id: sessionID, name: inputNick.value });
        inputNick.value = '';
      }

      function sendMessage() {
        const message = inputMessage.value;
        socket.emit('requestMessageSend', { id: sessionID, nickname, message });
        inputMessage.value = '';
      }

      function loadMessages() {
        socket.emit('requestMessagesList')
      }

      window.addEventListener('beforeunload', function (e) {
        e.preventDefault();
        socket.emit('disconnect');
      });

      // call all functions
      userJoin();
      loadMessages();
    </script>
  </body>
</html>
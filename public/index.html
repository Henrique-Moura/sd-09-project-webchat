// https://www.youtube.com/watch?v=-jXfKDYJJvo - Chat em tempo real com NodeJS + Socket.io | Diego Fernandes

<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Web Chat</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>

    <link rel="stylesheet" href="styles.css">
  </head>
  <body id="chat">
      <ul id="online-users"></ul>

      <input
        type="text"
        data-testid="nickname-box"
        id="nickname-box"
        placeholder="Digite um nickname"
      >

      <button type="button" data-testid="nickname-button" id="nickname-button">
        Trocar nickname
      </button>

      <input
        type="text"
        data-testid="message-box"
        id="message-box"
        placeholder="Digite uma mensagem"
      >

      <button type="button" data-testid="send-button" id="send-button">
          Enviar Mensagem
      </button>

      <ul id="messages" class="messages"></ul>

      <script src="/socket.io/socket.io.js"></script>
      <script>
        const socket = window.io();

        const messageInput = document.querySelector('#message-box');
        const nickNameInput = document.querySelector('#nickname-box');
        const changeNicknameButton = document.querySelector('#nickname-button');
        const sendMessageButton = document.querySelector('#send-button');
        const onlineUsersList = document.querySelector('#online-users');
        const messagesList = document.querySelector('#messages');
        let nickname = null;

        changeNicknameButton.addEventListener('click', () => {
          if(!nickNameInput.value) return;
          socket.emit('changeNickname', nickNameInput.value);
          nickname = nickNameInput.value;
          nickNameInput.value = '';
        });

        sendMessageButton.addEventListener('click', () => {
          if(!messageInput.value) return;
          socket.emit('message', {
              nickname,
              chatMessage: messageInput.value,
          });
          messageInput.value = '';
        });

        socket.on('changeNickname', (newNickname) => {
          nickname = newNickname;
        });

        socket.on('message', (data) => {
          const li = document.createElement('li');
          li.innerText = data;
          li.setAttribute('data-testid', 'message'); 
          messagesList.appendChild(li);
        });

        socket.on('allUsers', (allUsers) => {
          onlineUsersList.innerHTML = '';
          const userLi = document.createElement('li');
          userLi.innerText = nickname;
          userLi.setAttribute('data-testid', 'online-user'); 
          onlineUsersList.appendChild(userLi);

          const filter = allUsers.filter((f) => f !== nickname);
          filter.forEach((user) => {
            const li = document.createElement('li');
            li.innerText = user;
            li.setAttribute('data-testid', 'online-user'); 
            onlineUsersList.appendChild(li);
          });
        });

        socket.on('chatMongoDB', (mongoDB) => {
          mongoDB.forEach((messageDB) => {
            const li = document.createElement('li');
            li.innerText = messageDB.message;
            li.setAttribute('data-testid', 'message'); 
            messagesList.appendChild(li);
          });
        });
      </script>
  </body>
</html>